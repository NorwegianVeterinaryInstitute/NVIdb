--- 
title: "Retrieve and standardize PJS-data examplified with data for one disease"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Retrieve and standardize PJS-data}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

-   [Overview](#overview)
-   [Set up the R environment](#set-up-the-r-environment)
-   [Login to PJS](#login-to-pjs)
-   [Make selection statement](#make-selection-statement)
-   [Retrieve PJS-data](#retrieve-pjs-data)
-   [Standardize PJS-data](#standardize-pjs-data)
-   [One sample and analytt per row](#one-sample-and-analytt-per-row)

## Overview
The purpose of this vignette is to give the main points when retrieving data from PJS. So that the method is Standardize at the NVI. And help to care of different points to achive good data.
# DESIGN ----
# Seleksjonskriterier er metoder, resultatanalytt, konklusjonsanalytt, sykdom og hensikter
# Simple control of selection parameters
# Standard cleaning of data
# Save data as rds-files

## Set up the R environment
In this part you want to set up the R environment for all script that are called (sourced) by the main script. This includes attaching all packages needed and setting global variables and functions.

### Attach packages
In base one use `library` or `require` to attach packages. Of these `library` is preferred as `require` will not produce an error message if a package isn't attached. 

An alternative is to use `use_pkg` and `use_NVIverse` from package `NVIbatch`. These functions accept a vector with package names and will attach the packages if installed, and install the package first if not installed. Use `use_pkg` for packages at "Cran" and `use_NVIverse` for packages within the "NVIverse".  If the packages need to be installed, the user running the batch needs writing access to the directories for R-packages.
```{r, include = TRUE}
# SET UP R-ENVIRONMENT ----
## Attach R-packages ----
library(NVIbatch)
use_pkg(pkg = c("dplyr", "RODBC"))
use_NVIverse("NVIdb")
```

### Set global variables
The global variables are put in section in the main script. In this example there are two global variables, the path to the R scripts and today's date. 
```{r, include = TRUE}
## Paths and filenames ----
# The path to the R-scripts.
domene <- paste0(set_dir_NVI("OKprogrammer"),"outbreak_123_2022/.../rscripts/")
script_path <- dirname(rstudioapi::getSourceEditorContext()$path)

aar <- c(2021)


# Today's date in the format yyyymmdd for use in filenames.
today <- format(Sys.Date(), "%Y%m%d")
```

### Define functions
These are functions needed for the script that are not included in any package, either because they are very specific for this script or that they are not yet mature for being included into a package. The example is a function for aggregating kjennelser into a higher level and this function is not yet mature for being included into a package. 

```{r, include = TRUE}
# Functions
source(paste0(set_dir_NVI("OKprogrammer"), "Rutine", aar, "/Rapportering/Rscripts/", "agg_kjennelse.R"), encoding = "UTF-8")

```

# Import support registers


```{r, include = TRUE}
# support registers
kommune_fylke <- read_kommune_fylke()
PJS_codes_2_text <- read_PJS_codes_2_text()
```


## READ DATA FROM PJS ----
# 1. Construct a selection-statement
#    Example: All saker related to one disease in 2021
#             ~ all saker with rabies-specific hensikt
#             + all saker with analytt rabies or lyssavirus for konklusjon or resultat
#             + all saker med metode specific for rabies


```{r, include = TRUE}
# RUN SCRIPTS ----



# Set selection parameters
purpose <- "Rabies"
aar <- c(2020)
hensikt2select <- c("0100101020", "0100102026", "0100103026", "0200144", "06035")
metode2select <- c("030010", "070017", "070180", "070245")
analytt2select <-  c("011402%","1502010241")    # Lyssavirus med underliggende og rabies


# ok_gris_virus
purpose <- "ok_gris_virus"
source(file = paste0(set_dir_NVI("OKprogrammer"), "Rutine", aar, "/Rapportering/Rscripts/OK_selection_parameters/", purpose, "_selection_parameters.R"))
source(file = paste0(domene, "/retrieve_ok_data_from_PJS.R"))

```

## LOGIN TO PJS ----
# 1. Set username and password (credentials) for PJS. 
#    The credentials are saved in the users profile (at the current machine). 
#    Do once. Must be repeated when password to PJS changes or if you use another PC

```{r, include = TRUE}
# set_credentials_PJS()
# READ DATA FROM PJS ----
journal_rapp <- login_by_credentials_PJS()

select_statement <- NVIdb::build_query_one_disease(year = aar, 
                                                   analytt = c(),
                                                   hensikt = hensikt2select,
                                                   metode = c())

PJSrawdata <- sqlQuery(journal_rapp,
                       select_statement["selection_v2_sak_m_res"],
                       as.is = TRUE,
                       stringsAsFactors = FALSE)


PJSsakskonklusjon <- sqlQuery(journal_rapp,
                              select_statement["selection_sakskonklusjon"],
                              as.is = TRUE,
                              stringsAsFactors = FALSE)

odbcClose(journal_rapp)

```

## STANDARDIZE DATA ----
# - The unnecessary columns konkl_provenr and vet_distriktnr are removed
# - The column names are standardized using standardize_columns
# - Numeric variables are transformed to numbers
# - Date variables are transformed to date format
# - Character variables are trimmed for leading and trailing spaces
# - The variables saksnr and, if possible, fagnr are generated
# - Test data, i.e. saker with ansvarlig_seksjon in c("14", "99") are deleted

```{r, include = TRUE}
# STANDARDIZE DATA ----
## Standard cleaning of data
PJSdata <- standardize_PJSdata(PJSdata = PJSrawdata)
sakskonklusjon <- standardize_PJSdata(PJSdata = PJSsakskonklusjon) 

## Exclude ring trials, quality assurance and samples from abroad
PJSdata <- exclude_from_PJSdata(PJSdata = PJSdata, abroad = "exclude", quality = "exclude")
sakskonklusjon <- exclude_from_PJSdata(PJSdata = sakskonklusjon, abroad = "exclude", quality = "exclude")


```
## KEEP VARIABLES IN SAK, PROVE AND KONKLUSJON -LEVEL ----
PJSdata <- choose_PJS_levels(data = PJSdata,
                             levels = c("sak", "prove", "konklusjon"),
                             keep_col = NULL,
                             remove_col = c("konklnr", "konkl_type"),
                             unique_rows = TRUE)

## TRANSLATE CODES INTO DESCRIPTIVE TEXT  ----
### Import support registers
PJS_codes_2_text <- read_PJS_codes_2_text()

### Translate PJS-codes to code descriptions
PJSdata <- add_PJS_code_description(data = PJSdata,
                                    translation_table = PJS_codes_2_text,
                                    PJS_variable_type = c("hensikt", "art", "driftsform", "provetype",
                                                          "provemateriale", "kjonn", "kjennelse", "analytt"),
                                    code_colname = c("hensiktkode", "artkode", "driftsformkode", "provetypekode",
                                                     "provematerialekode", "kjonn", "konkl_kjennelsekode", "konkl_analyttkode"),
                                    new_column = c("hensikt", "art", "driftsform", "provetype",
                                                   "provemateriale", "kjonn2", "konkl_kjennelse", "konkl_analytt"),
                                    position = "right",
                                    overwrite = FALSE)




```{r, include = TRUE}
## ONE ROW PER PRØVE, UNDERSØKELSE AND KONKLUSJON ----
# Remove unnecessary rows due to cartesian product ----

# TO DO: accept varying length for analytter in selections, can be done by for-loop for each analytt and missing
source(paste0("./one_row_per_sample_konkl_res.R"), encoding = "UTF-8")

# Add sakskonklusjon
# 1. Når identisk analyttkode
sakskonklusjon <- sakskonklusjon %>%
  dplyr::select(-c(konklnr, konkl_typekode)) %>%
  dplyr::rename(sakskonkl_kjennelsekode = konkl_kjennelsekode, sakskonkl_analyttkode = analyttkode) %>%
  dplyr::mutate(sakskonkl_analyttkode = dplyr::case_when(is.na(sakskonkl_analyttkode) & !is.na(sakskonkl_kjennelsekode) ~ "missing",
                                                         TRUE ~ sakskonkl_analyttkode)) %>%
  dplyr::mutate(sakskonkl_kjennelsekode = dplyr::case_when(!is.na(sakskonkl_analyttkode) & is.na(sakskonkl_kjennelsekode) ~ "missing",
                                                           TRUE ~ sakskonkl_kjennelsekode)) %>%
  
  dplyr::filter(substr(sakskonkl_analyttkode, 1, length_analytt) %in% c(analytt, substr("missing", 1, length_analytt))) %>%
  dplyr::distinct() 

tempX <- sakskonklusjon %>%
  dplyr::select(saksnr, sakskonkl_kjennelsekode, sakskonkl_analyttkode) %>%
  dplyr::distinct()

temp <- PJSdata %>%
  dplyr::inner_join(tempX, by = c("saksnr" = "saksnr", "konkl_analyttkode" = "sakskonkl_analyttkode")) %>%
  dplyr::mutate(sakskonkl_analyttkode = konkl_analyttkode)

sakskonklusjon <- subset(sakskonklusjon, 
                         !paste(saksnr, sakskonkl_kjennelsekode, sakskonkl_analyttkode, sep = "-") %in%
                           paste(temp$saksnr, temp$sakskonkl_kjennelsekode, temp$sakskonkl_analyttkode, sep = "-"))

PJSdata <- subset(PJSdata, 
                  !paste(saksnr, konkl_kjennelsekode, konkl_analyttkode, sep = "-") %in%
                    paste(temp$saksnr, temp$konkl_kjennelsekode, temp$konkl_analyttkode, sep = "-"))

# 2. Når analyttkode er lik på de første sifrene
tempX <- sakskonklusjon %>%
  dplyr::select(saksnr, sakskonkl_kjennelsekode, sakskonkl_analyttkode) %>%
  dplyr::mutate(analyttkode = substr(sakskonkl_analyttkode, 1, length_analytt)) %>%
  dplyr::distinct()

tempX <- PJSdata %>%
  # dplyr::select(-c(sakskonkl_kjennelsekode, sakskonkl_analyttkode)) %>%
  dplyr::mutate(analyttkode = substr(konkl_analyttkode, 1, length_analytt)) %>%
  dplyr::inner_join(tempX, by = c("saksnr" = "saksnr", "analyttkode" = "analyttkode")) %>%
  dplyr::select(-analyttkode)

sakskonklusjon <- subset(sakskonklusjon, 
                         !paste(saksnr, sakskonkl_kjennelsekode, sakskonkl_analyttkode, sep = "-") %in%
                           paste(tempX$saksnr, tempX$sakskonkl_kjennelsekode, tempX$sakskonkl_analyttkode, sep = "-"))

PJSdata <- subset(PJSdata, 
                  !paste(saksnr, konkl_kjennelsekode, konkl_analyttkode, sep = "-") %in%
                    paste(tempX$saksnr, tempX$konkl_kjennelsekode, tempX$konkl_analyttkode, sep = "-"))

PJSdata <- dplyr::bind_rows(temp, tempX, PJSdata, sakskonklusjon)

saveRDS(PJSdata, file = paste0(set_dir_NVI("OKprogrammer"), "Rutine", aar, "/Rapportering/Radata/", purpose, ".rds"))
```


